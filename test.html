<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DatePicker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="flex w-full flex-col gap-2 lg:w-[235px]">
    <div class="space-y-4">
      <button
        id="datepicker-button"
        data-slot="button"
        class="focus-visible:border-ring focus-visible:ring-ring/50 disabled:bg-primary-disabled disabled:text-content-primary-disabled aria-invalid:border-destructive aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 inline-flex shrink-0 items-center text-sm font-medium whitespace-nowrap transition-[color,box-shadow] outline-none hover:cursor-pointer focus-visible:ring-[3px] disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 border-input bg-background h-9 has-[>svg]:px-3 !mb-0 min-h-12 w-full flex-col justify-start gap-2 border-0 px-0 py-0 text-left lg:flex lg:h-[70px] lg:border-b"
        aria-label="Open calendar"
        type="button"
        aria-haspopup="dialog"
        aria-expanded="false"
        data-state="closed"
      >
        <div class="hidden w-full lg:block">
          <div class="flex w-full min-w-0 flex-1 items-center justify-between lg:px-2">
            <span class="text-content-secondary py-1 text-sm lg:py-2">Ngày khởi hành</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round"
                 class="lucide lucide-calendar h-4 w-4 flex-shrink-0" aria-hidden="true">
              <path d="M8 2v4" />
              <path d="M16 2v4" />
              <rect width="18" height="18" x="3" y="4" rx="2" />
              <path d="M3 10h18" />
            </svg>
          </div>
          <div class="flex w-full items-center justify-start gap-2 lg:px-2 lg:pt-2">
            <span id="date-summary" class="text-content-primary truncate text-base font-medium">Vui lòng chọn ngày</span>
          </div>
        </div>
        <div class="flex w-full items-center justify-between lg:hidden">
          <div class="flex flex-col items-start gap-1">
            <span id="date-summary-mobile" class="text-content-primary text-base leading-6 font-medium">Vui lòng chọn ngày</span>
            <span class="text-content-secondary text-xs leading-5">Ngày khởi hành</span>
          </div>
          <div class="h-4 w-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round"
                 class="lucide lucide-chevron-down text-content-primary size-4" aria-hidden="true">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </div>
        </div>
      </button>
    </div>

    <div
      id="datepicker-dropdown"
      style="display: none; position: fixed; z-index: 9999;"
      class="bg-white rounded-lg border shadow-xl p-6 w-[750px] max-h-[80vh] overflow-auto"
    >
      <!-- Calendar Header -->
      <div class="flex items-center justify-between mb-6">
        <button id="prev-month" type="button" class="p-2 hover:bg-gray-100 rounded-md">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6" />
          </svg>
        </button>

        <h2 id="month-title" class="text-xl font-semibold text-center flex-1 mx-4">
          Tháng Mười 2025 | Tháng Mười Một 2025
        </h2>

        <button id="next-month" type="button" class="p-2 hover:bg-gray-100 rounded-md">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6" />
          </svg>
        </button>
      </div>

      <!-- Two Month View -->
      <div id="calendar-container" class="flex gap-8 mb-6"></div>

      <!-- Footer -->
      <div class="flex items-center justify-between pt-4 border-t">
        <div class="flex items-center gap-2">
          <button id="lunar-toggle" type="button"
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gray-300">
            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
          </button>
          <span class="text-sm text-gray-700">Âm lịch</span>
        </div>

        <div class="flex gap-2">
          <button id="reset-dates" type="button"
                  class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Chọn lại
          </button>
          <button id="apply-dates" type="button"
                  class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800">
            Chọn
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============== State ==============
    let isOpen = false;
    let isLunarCalendar = false;
    let currentMonth = new Date(2025, 9, 1); // October 2025
    let departDate = new Date(2025, 9, 8); // demo
    let returnDate = null;
    let tripType = 'round-trip';

    const buttonRef = document.getElementById('datepicker-button');
    const dropdownRef = document.getElementById('datepicker-dropdown');
    const dateSummaryRef = document.getElementById('date-summary');
    const dateSummaryMobileRef = document.getElementById('date-summary-mobile');
    const monthTitleRef = document.getElementById('month-title');

    const monthsVN = [
      'Tháng Một','Tháng Hai','Tháng Ba','Tháng Tư','Tháng Năm','Tháng Sáu',
      'Tháng Bảy','Tháng Tám','Tháng Chín','Tháng Mười','Tháng Mười Một','Tháng Mười Hai'
    ];

    // ============== Lunar helpers ==============
    const hasChineseCalendar = (() => {
      try {
        // Will throw in some very old browsers
        new Intl.DateTimeFormat('vi-VN-u-ca-chinese');
        return true;
      } catch {
        return false;
      }
    })();

    function getLunarDay(date) {
      if (!hasChineseCalendar) return null;
      const parts = new Intl.DateTimeFormat('vi-VN-u-ca-chinese', {
        day: 'numeric',
        timeZone: 'Asia/Ho_Chi_Minh'
      }).formatToParts(date);
      const p = parts.find(x => x.type === 'day');
      return p ? Number(p.value) : null;
    }

    // Optional: lấy tháng âm nếu cần hiển thị
    function getLunarMonth(date) {
      if (!hasChineseCalendar) return null;
      const parts = new Intl.DateTimeFormat('vi-VN-u-ca-chinese', {
        month: 'numeric',
        timeZone: 'Asia/Ho_Chi_Minh'
      }).formatToParts(date);
      const p = parts.find(x => x.type === 'month');
      return p ? Number(p.value) : null;
    }

    // ============== Utils ==============
    const getDaysInMonth = (date) => {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0=CN .. 6=Th 7
      return { daysInMonth, startingDayOfWeek };
    };

    const formatDate = (date) => {
      return date.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" });
    };

    const getDateSummary = () => {
      if (!departDate) return "Vui lòng chọn ngày";
      if (tripType === "one-way" || !returnDate) return formatDate(departDate);
      return `${formatDate(departDate)} - ${formatDate(returnDate)}`;
    };

    const updateSummary = () => {
      const summary = getDateSummary();
      dateSummaryRef.textContent = summary;
      dateSummaryMobileRef.textContent = summary;
    };

    const isDateSelected = (day, displayMonth) => {
      const date = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day);
      if (departDate && date.toDateString() === departDate.toDateString()) return true;
      if (returnDate && date.toDateString() === returnDate.toDateString()) return true;
      return false;
    };

    const isDateInRange = (day, displayMonth) => {
      if (!departDate || !returnDate) return false;
      const date = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day);
      return date > departDate && date < returnDate;
    };

    const handleDateClick = (day, displayMonth) => {
      const clickedDate = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day);
      if (!departDate) {
        departDate = clickedDate;
      } else if (tripType === "round-trip" && !returnDate) {
        if (clickedDate < departDate) {
          returnDate = departDate;
          departDate = clickedDate;
        } else {
          returnDate = clickedDate;
        }
      } else {
        departDate = clickedDate;
        if (tripType === "round-trip") returnDate = null;
      }
      renderCalendars();
      updateSummary();
      updateMonthTitle();
    };
    window.handleDateClick = handleDateClick;

    const getMonthName = (date) => {
      return date.toLocaleDateString("vi-VN", { month: "long", year: "numeric" });
    };

    const updateMonthTitle = () => {
      let year2 = currentMonth.getFullYear();
      let month2 = currentMonth.getMonth() + 1;
      if (month2 > 11) { month2 = 0; year2 = currentMonth.getFullYear() + 1; }
      monthTitleRef.innerHTML = `${monthsVN[currentMonth.getMonth()]} ${currentMonth.getFullYear()} | ${monthsVN[month2]} ${year2}`;
    };

    // ============== Renderers ==============
    const renderCalendar = (monthOffset) => {
      const displayMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + monthOffset, 1);
      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(displayMonth);
      const days = [];
      const weekDays = ["Th 2","Th 3","Th 4","Th 5","Th 6","Th 7","CN"];

      // số ô trống đầu tuần (tuần bắt đầu từ Thứ 2)
      const emptiesCount = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;

      // ô trống
      for (let i = 0; i < emptiesCount; i++) {
        days.push('<div class="h-12 flex items-center justify-center"></div>');
      }

      // ngày trong tháng
      for (let day = 1; day <= daysInMonth; day++) {
        const isSelected = isDateSelected(day, displayMonth);
        const inRange = isDateInRange(day, displayMonth);

        let className = `h-12 flex items-center justify-center text-sm font-medium transition-colors relative cursor-pointer`;
        if (isSelected) {
          className += ` bg-red-700 text-white rounded-md z-10`;
        } else if (inRange) {
          className += ` bg-red-50`;
        } else {
          className += ` hover:bg-gray-100`;
        }

        // Lunar day (tính thật, có fallback)
        let lunarBadge = "";
        if (isLunarCalendar) {
          const lunarDay = getLunarDay(new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day));
          const lunarMonth = getLunarMonth(new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day));
          if (lunarDay) {
            if (lunarDay === 1 && lunarMonth) {
              lunarBadge = `<span class="absolute -top-2 -right-2 text-[10px] font-semibold text-red-500">1/${lunarMonth}</span>`;
            } else {
              lunarBadge = `<span class="absolute -top-2 -right-2 text-[10px] text-gray-400">${lunarDay}</span>`;
            }
          } else {
            lunarBadge = `<span class="absolute -top-2 -right-2 text-[10px] text-gray-400">—</span>`;
          }
        }

        const safeMonth = displayMonth.getMonth();
        const safeYear = displayMonth.getFullYear();

        const dayHtml = `
          <button type="button"
                  class="${className}"
                  onclick="handleDateClick(${day}, new Date(${safeYear}, ${safeMonth}, 1))">
            <span class="relative">${day}${lunarBadge}</span>
          </button>
        `;
        days.push(dayHtml);
      }

      // Padding tới 6 hàng (42 ô)
      const total = emptiesCount + daysInMonth;
      const needed = 42 - total;
      for (let i = 0; i < needed; i++) {
        days.push('<div class="h-12 flex items-center justify-center"></div>');
      }

      return `
        <div class="flex-1">
          <div class="text-center font-medium mb-4 capitalize">${getMonthName(displayMonth)}</div>
          <div class="grid grid-cols-7 gap-1 mb-2">
            ${weekDays.map(d => `<div class="h-8 flex items-center justify-center text-xs text-gray-500 font-medium">${d}</div>`).join('')}
          </div>
          <div class="grid grid-cols-7 gap-1">${days.join('')}</div>
        </div>
      `;
    };

    const renderCalendars = () => {
      const container = document.getElementById('calendar-container');
      container.innerHTML = `${renderCalendar(0)}${renderCalendar(1)}`;
    };

    // ============== Navigation ==============
    const previousMonth = () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendars(); updateMonthTitle(); calculatePosition();
    };
    const nextMonth = () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendars(); updateMonthTitle(); calculatePosition();
    };

    // ============== Actions ==============
    const toggleLunar = () => {
      isLunarCalendar = !isLunarCalendar;
      const toggleBtn = document.getElementById('lunar-toggle');
      const toggleSpan = toggleBtn.querySelector('span');
      if (isLunarCalendar) {
        toggleBtn.classList.remove('bg-gray-300'); toggleBtn.classList.add('bg-blue-500');
        toggleSpan.classList.remove('translate-x-1'); toggleSpan.classList.add('translate-x-6');
      } else {
        toggleBtn.classList.remove('bg-blue-500'); toggleBtn.classList.add('bg-gray-300');
        toggleSpan.classList.remove('translate-x-6'); toggleSpan.classList.add('translate-x-1');
      }
      renderCalendars();
    };

    const resetDates = () => {
      departDate = new Date();
      returnDate = null;
      renderCalendars();
      updateSummary();
    };

    const applyDates = () => {
      console.log('Selected dates:', { departDate, returnDate });
      toggleDropdown();
    };

    const toggleDropdown = () => {
      isOpen = !isOpen;
      const dropdown = dropdownRef;
      const button = buttonRef;
      if (isOpen) {
        dropdown.style.display = 'block';
        button.setAttribute('aria-expanded', 'true');
        button.setAttribute('data-state', 'open');
        calculatePosition();
        renderCalendars();
        updateMonthTitle();
      } else {
        dropdown.style.display = 'none';
        button.setAttribute('aria-expanded', 'false');
        button.setAttribute('data-state', 'closed');
      }
    };

    const calculatePosition = () => {
      const rect = buttonRef.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      const dropdownHeight = 500;
      const dropdownWidth = 750;

      let top = rect.bottom + window.scrollY + 8;
      let left = rect.left + window.scrollX;

      if (rect.bottom + dropdownHeight > viewportHeight) {
        top = rect.top + window.scrollY - dropdownHeight - 8;
      }
      if (rect.left + dropdownWidth > viewportWidth) {
        left = viewportWidth - dropdownWidth - 20;
      }
      if (left < 0) left = 10;

      dropdownRef.style.top = `${Math.max(10, top)}px`;
      dropdownRef.style.left = `${Math.max(10, left)}px`;
    };

    const handleClickOutside = (event) => {
      if (!isOpen) return;
      if (dropdownRef && !dropdownRef.contains(event.target) && buttonRef && !buttonRef.contains(event.target)) {
        toggleDropdown();
      }
    };

    const handleResizeOrScroll = () => {
      if (isOpen) calculatePosition();
    };

    // ============== Events ==============
    buttonRef.addEventListener('click', toggleDropdown);
    document.getElementById('prev-month').addEventListener('click', previousMonth);
    document.getElementById('next-month').addEventListener('click', nextMonth);
    document.getElementById('lunar-toggle').addEventListener('click', toggleLunar);
    document.getElementById('reset-dates').addEventListener('click', resetDates);
    document.getElementById('apply-dates').addEventListener('click', applyDates);

    document.addEventListener('mousedown', handleClickOutside);
    window.addEventListener('resize', handleResizeOrScroll, { passive: true });
    window.addEventListener('scroll', handleResizeOrScroll, { passive: true });

    // ESC to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) toggleDropdown();
    });

    // Initial render
    updateSummary();
    updateMonthTitle();
  </script>
</body>
</html>
